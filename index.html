<doctype html>
    <html>

    <head>
        <title>Nearby Cafes</title>
        <!-- @TODO make the font-size for the text on the page responsive too -->
        <link rel="stylesheet" href="main.css" type="text/css" />
        <!-- Include the Google Maps API -->
        <script
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDeWCL9MAAj_ZXzCK0KGIk400Q2SfOqSOA&libraries=places,geometry"></script>
        <script type="text/javascript" src="Winwheel.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.3/gsap.min.js"></script>
    </head>

    <body>
        <div align="center">
            <h1>Indecider App</h1>
            <br />
            <p>Find a cafe in 500m.</p>
            <br />
            <br />
            <div class="triangle-down"></div>
            <!-- Always set canvas to largest desired size, i.e. desktop PC size, it will be scaled down for smaller devices but never scaled up -->
            <canvas id="canvas" width="500" height="500" data-responsiveMinWidth="180" data-responsiveScaleHeight="true"
                onClick="startSpin();">
                <p style="color: white" align="center">Sorry, your browser doesn't support canvas. Please try another.
                </p>
            </canvas>
            <br /><br />
            <p align="center">Tap the wheel to spin.</p>
            <div id="map"></div>
        </div>
        <script>
            var map;
            var names = [];
            var formattedNames = [];
            var pos;
            let theWheel;


            // Get the user's current location
            navigator.geolocation.getCurrentPosition(function (position) {
                pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                // Initialize the map
                var map = new google.maps.Map(document.getElementById('map'), {
                    center: pos,
                    zoom: 18
                });

                // Search for nearby cafes
                var service = new google.maps.places.PlacesService(map);
                service.nearbySearch({
                    location: pos,
                    radius: 500,
                    type: ['cafe']
                }, callback);
            });

            // Handle the results of the search
            function callback(results, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    var names = [];
                    for (var i = 0; i < results.length; i++) {
                        names.push(results[i].name);
                    }
                    const formattedNames = names.map(name => ({ text: name }));
                    console.log(names);
                    console.log(formattedNames);
                    makeWheel(names,formattedNames);
                }
            }

            function makeWheel(names, formattedNames) {
                // Create new wheel object specifying the parameters at creation time.
                theWheel = new Winwheel({
                    'numSegments': names.length,     // Specify number of segments.
                    'textFontSize': 16,    // Set font size as desired.
                    'responsive': true,  // This wheel is responsive!
                    'segments': formattedNames,   // Define segments including colour and text.
                    'animation':           // Specify the animation to use.
                    {
                        'type': 'spinToStop',
                        'duration': 5,     // Duration in seconds.
                        'spins': 8,     // Number of complete spins.
                    }
                });
            }

            // -----------------------------------------------------------------
            // Called by the onClick of the canvas, starts the spinning.
            function startSpin() {
                // Stop any current animation.
                theWheel.stopAnimation(false);

                // Reset the rotation angle to less than or equal to 360 so spinning again
                // works as expected. Setting to modulus (%) 360 keeps the current position.
                theWheel.rotationAngle = theWheel.rotationAngle % 360;

                // Start animation.
                theWheel.startAnimation();
            }

        </script>
    </body>

    </html>
